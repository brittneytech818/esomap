---
import HeaderNav from "@/components/HeaderNav.astro";
import HeaderMeta from "@/components/HeaderMeta.astro";
import ScrollToTop from "@/components/ScrollToTop.astro";
import Footer from "@/components/Footer.astro";
import Pagination from "@/components/Pagination.astro";
import { SITE_TITLE, SITE_DESCRIPTION, ESO_API_URL, CDN_URL } from "@/consts";

let page = Astro.url.searchParams.get("page") || 1;

if (!/^\d+$/.test(page as string)) {
  page = 1;
}

const query = new URLSearchParams();
query.set("pagination[pageSize]", "20");
query.set("pagination[page]", page as string);

const response = await fetch(`${ESO_API_URL}/api/set-summaries?${query}`);
const result = await response.json();

if (result.error) {
  return new Response(result.error.message, {
    status: result.error.status,
    statusText: result.error.message,
  });
}

const {
  data = [],
  meta: { pagination },
} = result;
---

<html lang="zh-CN">
  <head>
    <HeaderMeta title={`套装 - ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
    <link rel="stylesheet" href={`${CDN_URL}/assets/gfm-fba346.css`} />
  </head>

  <body>
    <HeaderNav />

    <main class="max-w-screen-xl mx-auto">
      <h1 class="text-2xl font-bold">套装</h1>
      <Pagination {...pagination} />
      <div class="markdown-body w-full">
        <table class="w-full">
          <thead class="whitespace-nowrap">
            <tr>
              <th class="w-44">名称</th>
              <th class="w-20">类型</th>
              <th>套装效果</th>
            </tr>
          </thead>
          <tbody>
            {
              data.map(({ id, attributes }: any) => (
                <tr>
                  <td class="text-center">
                    <a href={`/set/${attributes.slug}`}>
                      {attributes.name}
                      <div class="text-xs">{attributes.nameEn}</div>
                    </a>
                  </td>
                  <td class="text-center">{attributes.type}</td>
                  <td
                    set:html={Array(7)
                      .fill(0)
                      .map((_, i) => attributes[`setBonusDesc${i + 1}`])
                      .filter(Boolean)
                      .join("<br/>")}
                  />
                </tr>
              ))
            }
          </tbody>
        </table>
      </div>
      <Pagination {...pagination} />
    </main>
    <ScrollToTop />
    <Footer />
  </body>
</html>
